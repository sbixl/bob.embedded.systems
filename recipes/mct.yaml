inherit: [ "basement::rootrecipe" ]

environment:
    BOARD_KERNEL:           "bcm2711"
    BOARD_KERNEL_DTB:       "bcm2711-rpi-4-b"    
    BOARD_CUSTOM_CONFIG:    "mct"

provideVars:
    BOARD_KERNEL:           "${BOARD_KERNEL}"
    BOARD_KERNEL_DTB:       "${BOARD_KERNEL_DTB}"
    BOARD_CUSTOM_CONFIG:    "${BOARD_CUSTOM_CONFIG}"

depends:
    # host tools
    - 
        name: utils::mtools
        use: [tools]
        tools:
            target-toolchain: host-toolchain
    -    
        name: devel::cross-toolchain-aarch64-linux-gnu
        use: [tools, environment]
        forward: True
    -
        name: board::bsp::rpi::linux-image
        use: [environment, result]
    -   board::bsp::rpi::firmware
    -   board::rootfs

buildVars: [ARCH, LINUX_VERSION]
buildScript: |
    mkdir -p boot

    # install kernel
    rsync -a ${BOB_DEP_PATHS["board::bsp::rpi::linux-image"]}/boot/kernel.img boot/
    
    # copy device tree files
    rsync -a ${BOB_DEP_PATHS["board::bsp::rpi::linux-image"]}/boot/dtbs/ dtbs/

    # install minimal bootloader binaries from rpi-firmware
    pushd boot
    # get closed source (minimal) bootloader firmware binaries
    cp ${BOB_DEP_PATHS["board::bsp::rpi::firmware"]}/boot/bootcode.bin .
    cp ${BOB_DEP_PATHS["board::bsp::rpi::firmware"]}/boot/start4.elf .
    # optional: used to configure the SDRAM partition between GPU and CPU
    cp ${BOB_DEP_PATHS["board::bsp::rpi::firmware"]}/boot/fixup4.dat .
    popd

    # create config.txt
    cat > boot/config.txt << EOF
    start_file=start4.elf
    fixup_file=fixup4.dat

    kernel=kernel.img
    initramfs initramfs followkernel

    # How much memory in MB to assign to the GPU on Pi models having
    # 256, 512 or 1024 MB total memory
    gpu_mem_256=100
    gpu_mem_512=100
    gpu_mem_1024=100

    # fixes rpi (3B, 3B+, 3A+, 4B and Zero W) ttyAMA0 serial console
    dtoverlay=miniuart-bt
    # use UART2 for communication with real-time system (microcontroller)
    dtoverlay=uart2

    # enable 64bits support
    arm_64bit=1
    EOF

    # kernel cmdline
    cat > boot/cmdline.txt << EOF
    console=tty1 console=ttyAMA0,115200 initrd=/dev/ram0
    EOF

    # rootfs: create a initramfs from the rootfs
    (
        cd ${BOB_DEP_PATHS["board::rootfs"]}
        find . | sort | cpio --create --reproducible --format=newc --owner=root:root | gzip
    ) > initramfs


packageVars: [ARCH, BOARD_KERNEL_DTB]
packageTools: [mcopy]
packageScript: |
    # first create the boot partiton image file
    fallocate -l 200M boot.img
    # make a vfat file system (FAT32) out of the empty image file
    mkfs.vfat -F 32 boot.img

    # We use the mtools here because they can easy copy files from host filesystem to a target vfat image file
    # copy file XXX from $1/boot into root directory "::" of vfat image boot.img
    mcopy -i boot.img $1/dtbs/$LINUX_VERSION/broadcom/${BOARD_KERNEL_DTB}.dtb ::${BOARD_KERNEL_DTB}.dtb
    mcopy -i boot.img $1/boot/bootcode.bin ::bootcode.bin
    mcopy -i boot.img $1/boot/fixup4.dat ::fixup4.dat
    mcopy -i boot.img $1/boot/start4.elf ::start4.elf

    mcopy -i boot.img $1/boot/cmdline.txt ::cmdline.txt
    mcopy -i boot.img $1/boot/config.txt ::config.txt

    mcopy -i boot.img $1/boot/kernel.img ::kernel.img
    mcopy -i boot.img $1/initramfs ::initramfs

